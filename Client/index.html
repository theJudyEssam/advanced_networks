<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Inspection Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .control-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .sensor-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .alert {
            color: red;
            font-weight: bold;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Safety Inspection Dashboard</h1>
        
        <!-- LED Control -->
        <div class="control-card">
            <h2>LED Control</h2>
            <div class="status" id="led-status">OFF</div>
            <div class="button-group">
                <button id="led-on">ON</button>
                <button id="led-off">OFF</button>
            </div>
        </div>

        <!-- Sensor Data -->
        <div class="control-card">
            <h2>Environment</h2>
            <div class="sensor-row">
                <span>Temperature:</span>
                <span id="temperature">-- °C</span>
            </div>
            <div class="sensor-row">
                <span>Humidity:</span>
                <span id="humidity">-- %</span>
            </div>
        </div>

        <div class="control-card">
            <h2>Air Quality</h2>
            <div class="sensor-row">
                <span>Pollution:</span>
                <span id="air-quality">-- ppm</span>
            </div>
            <div class="sensor-row">
                <span>Status:</span>
                <span id="air-alert">Normal</span>
            </div>
        </div>

        <div class="control-card">
            <h2>Accelerometer</h2>
            <div class="sensor-row">
                <span>X-axis:</span>
                <span id="accel-x">-- m/s²</span>
            </div>
            <div class="sensor-row">
                <span>Y-axis:</span>
                <span id="accel-y">-- m/s²</span>
            </div>
            <div class="sensor-row">
                <span>Z-axis:</span>
                <span id="accel-z">-- m/s²</span>
            </div>
            <div class="sensor-row">
                <span>Status:</span>
                <span id="motion-alert">No motion</span>
            </div>
        </div>
    </div>
<script>

    
    const TEMP_ALERT = 30;       // °C
    const HUMIDITY_ALERT = 70;   // %
    const AIR_ALERT = 1000;      // ppm
    const MOTION_THRESHOLD = 15; // m/s² (for sudden movement)

    async function fetchEnvironmentData() {
        try {
            const response = await fetch('/api/environment');
            const data = await response.json();
            console.log(data)

            const tempElement = document.getElementById('temperature');
            const humElement = document.getElementById('humidity');

            tempElement.textContent = `${data.temperature.toFixed(1)} °C`;
            humElement.textContent = `${data.humidity.toFixed(1)} %`;

            if (data.temperature > TEMP_ALERT) {
                tempElement.classList.add('alert');
                sendAlert("High temperature warning!");
            } else {
                tempElement.classList.remove('alert');
            }

            if (data.humidity > HUMIDITY_ALERT) {
                humElement.classList.add('alert');
                sendAlert("High humidity warning!");
            } else {
                humElement.classList.remove('alert');
            }
        } catch (err) {
            console.error("Failed to fetch environment data:", err);
        }
    }

    async function fetchAirQualityData() {
        try {
            const response = await fetch('http://localhost:3000/api/air_quality');
            const data = await response.json();
            console.log(data)

            const airElement = document.getElementById('air-quality');
            const airAlertElement = document.getElementById('air-alert');

            airElement.textContent = `${data.air_quality.toFixed(0)} ppm`;

            if (data.air_quality > AIR_ALERT) {
                airAlertElement.textContent = "DANGER: Poor air quality!";
                airAlertElement.classList.add('alert');
                sendAlert("Air quality alert!");
            } else {
                airAlertElement.textContent = "Normal";
                airAlertElement.classList.remove('alert');
            }
        } catch (err) {
            console.error("Failed to fetch air quality data:", err);
        }
    }

    async function fetchAccelerationData() {
        try {
            const response = await fetch('http://localhost:3000/api/accelerometer');
            const data = await response.json();

            const x = data.accel_x;
            const y = data.accel_y;
            const z = data.accel_z;

            document.getElementById('accel-x').textContent = `${x.toFixed(2)} m/s²`;
            document.getElementById('accel-y').textContent = `${y.toFixed(2)} m/s²`;
            document.getElementById('accel-z').textContent = `${z.toFixed(2)} m/s²`;

            const totalAccel = Math.sqrt(x ** 2 + y ** 2 + z ** 2);
            const motionAlert = document.getElementById('motion-alert');

            if (totalAccel > MOTION_THRESHOLD) {
                motionAlert.textContent = "WARNING: Sudden movement!";
                motionAlert.classList.add('alert');
                sendAlert("Motion detected!");
            } else {
                motionAlert.textContent = "No motion";
                motionAlert.classList.remove('alert');
            }
        } catch (err) {
            console.error("Failed to fetch acceleration data:", err);
        }
    }

    async function fetchLedStatus() {
        try {
            const response = await fetch('/api/led/status');
            const data = await response.json();
            document.getElementById('led-status').textContent = data.status;
        } catch (err) {
            console.error("Failed to fetch LED status:", err);
        }
    }

    function sendAlert(message) {
        console.log("ALERT:", message);
        fetch('/api/alert', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        });
    }

   

    // Poll every 2 seconds
    function pollAllSensors() {
        fetchEnvironmentData();
        fetchAirQualityData();
        fetchAccelerationData();
        fetchLedStatus();
    }

    setInterval(pollAllSensors, 2000);
    pollAllSensors(); // Initial load
</script>

</body>
</html>